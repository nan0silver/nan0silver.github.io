---
layout: post
title: dev diary - 2023.09
description: >
  2023.09의 개발일지 입니다.
sitemap: false
---

## Dev Diary (2023.09)

### 2023.9.16

- 다이어그램 해설 기능 개발을 앱에서 실행시키기 위한 전처리 작업함 
    - ppt 한 장의 전체를 ocr을 실행하면 다이어그램 부분의 ocr이랑 섞여버리니까 분리해야함
    - 다이어그램이라는 정보를 알고 하기로 했으나, 다이어그램이 있는 위치를 특정하기 위해서 이미지 내의 두 번째로 큰 사각형을 탐지 (가장 큰 사각형은 이미지 전체의 아웃라인)
    - 두 번째로 큰 사각형을 잘라냈을 때 이 사각형안에 텍스트가 있는지 없는지 정도는 알아낼 수 있을 것 같다 
        - 이러면 다이어그램인지 아닌지 정도를 구분할 수 있으며, 다이어그램 안의 텍스트들을 알아낼 수 있다.
        - *OCR을 한 번만 해도 다이어그램 속 ocr정보와 ppt내의 텍스트 정보를 알 수 있음

### 2023.9.17

- 18일 아침까지 넘어가긴 했지만, 다이어그램 구별 알고리즘 개발 완성!!
    - ocr 감지 텍스트 박스의 왼쪽 위 좌표 (x0, y0)
    - cut image의 좌표(x,y)
    - ocr 감지 텍스트 박스의 오른쪽 아래 좌표 (x2, y2)
    - x <= x0 && y <= y0 && x+w >= x2 && y+h >= y2
        - 4개의 조건 만족시키는 텍스트박스 하나만 있어도 다이어그램이라 판단

### 2023.9.18 ~

- 다이어그램의 화살표와 텍스트박스 사이의 연결성을 발견하기 위한 연구
- Block Diagram이라고 특정
  - 현재 python으로 다이어그램 해석 알고리즘 개발 중
    1. 화살표의 시작점과 끝점을 찾고, 각각의 점과 가장 가까운 박스를 찾아야함
      - (시작점을 삼각형의 꼭짓점으로 생각)
      - 현재 화살표 검출의 핵심은 2개의 convex hull을 찾는 것.
      - <figure>
        <image src = "assets/img/blog/arrow_convexHull_img.png">

    1-1. 화살표의 끝점 찾기
      - 화살표의 convex hull의 x좌표가 화살표 시작점의 왼쪽에 있는지, 오른쪽에 있는지 확인 후, convex hull이 있는 쪽의 화살표 꼭짓점 중 x좌표 기준 가장 멀리 있는 점을 찾는다.
      - 위의 방법보단 항상 화살표 시작점부터 꼭짓점들의 배열에서 +3번째의 점이 끝점이 되기 때문에 이 방법을 선택

    1-2. 시작점과 끝점과 가장 가까운 박스 찾기
      - 박스들의 4개의 꼭짓점 좌표는 알고 있음
      - 박스의 가운데 좌표와 점사이 거리로 기준으로 하기엔 오류가 많음
      - 각 점과 가장 가까운 변을 가진 박스를 찾아야 한다.
        - 그냥 가장 가까운 꼭짓점을 가진 박스를 구하기로 하자.

    1-3. 화살표와 박스 사이 연결하기
      - 박스는 여러개의 화살표와 연결될 수 있지만, 현재 검출할 수 있는 화살표는 형태에 한계가 있는데, 따라서 각 점마다 1개의 박스와 연결할 수 있음
      - 따라서 모든 화살표들이 연결되는 박스들을 알아내는 것이 좋을 것 같음
      - 방향 그래프의 bfs(너비 우선 탐색)를 이용해 그래프들간의 순서를 정함
      - 박스들을 연결하고 사이에 연결된다는 말을 붙여서 설명을 완성함

- 이쯤 되니까 성능평가를 생각했는데, Block Diagram-to-Text: Understanding Block Diagram Images by Generating Natural Language Descriptors라는 논문을 찾게됨
  - 이 논문에 내가 하고자 했던 그대로가 나와있음 (use ai)
  - 데이터셋도 있는데 모든 다이어그램들이 상자와 화살표가 붙어있음
  - 상자와 붙어있는 화살표를 떼어낼 방법이 없을까..
    - 근데 붙어있으면 내가 하는 방법으로는 상자도 화살표고 감지가 안되는데 그냥 새로 데이터셋을 만드는 방법밖에 없을까
    - 근데 그렇게 되면 이미지만 만드는게 아니라 정답 데이터도 만들어야하는데 한세월걸릴듯..
    - 이 논문의 데이터들을 사용할 수 있으면 성능평가만 하면 되는건데..

- 화살표의 시작점과 끝점의 좌표를 아니까 할 수 있는 것이 많아졌다.
  - 화살표의 벡터값 계산
    - 다이어그램의 전체 방향성 알아내기
      - 상자들의 인덱스를 부여할 때, 가로로 가는 다이어그램과 세로로 가는 다이어그램간의 차이를 알아낼 수 있다.
    - 화살표와 상자 노드를 연결할 때, 화살표 벡터를 통해 가장 가까운 박스를 더 정확하게 찾을 수 있다.
      - 상자의 가운데점과 화살표 시작점, 끝점 각각의 거리를 측정해 가장 가까운 박스를 찾는데,
        - 상자의 크기가 차이가 나는 경우 상자가 커질 수록 가운데 점 사이의 거리가 늘어나면서 근처에 가깝지는 않지만 작은 상자의 가운데 점이 더 가까워지는 경우가 생겼다.
        - 이런 경우 화살표의 벡터값으로 정리해줄 수 있게 되었다.
  
- 여기까지 하니까 거의 모든 다이어그램 이미지가 오류 없이 설명문을 만들어 내었다.

- 그런데 화살표가 감지되지 않는 경우가 생겼다. 
  - 이미지 내의 객체들의 컨투어를 찾아 화살표를 감지한는 과정에서
  - <pre><code> approx = cv2.approxPolyDP(cnt, 0.025 * peri, True) 
      #peri는 외곽선의 길이
      #요철이 있는 부분은 무시하고 컨투어 계산
      #2번째 파라미터가 근사치 정확도
    </code></pre>

  - 위 코드에서 근사치 정확도의 값이 낮을 수록 근사를 적게해 원본 윤곽과 유사해짐
  - 너무 작으면(0.015) 짧은 화살표가 탐지되지 않고, 너무 크면(0.025) 긴 화살표가 탐지되지 않는다.

  - 빨리 논문 써야하기도 하고, 그냥 그래서 두번 다 검사하는 코드로 바꿨다.

  