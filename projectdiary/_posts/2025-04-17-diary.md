---
layout: post
collection: project_diary
title: ë²„í‹° í”„ë¡œì íŠ¸ ì¼ê¸°
description: >
  í…ŒìŠ¤íŠ¸
sitemap: false
---

# [ë²„í‹°] í”„ë¡œì íŠ¸ ê°œë°œ ì¤‘ ë§ˆì£¼í•œ ì‚¬ì†Œí•œ ì´ìŠˆë“¤

- [JJWT ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „ì— ë”°ë¥¸ ë³€ê²½ ì‚¬í•­](#1-jjwt-ë¼ì´ë¸ŒëŸ¬ë¦¬-ë²„ì „ì—-ë”°ë¥¸-ë³€ê²½-ì‚¬í•­)
- [ì¹´ì¹´ì˜¤ ì†Œì…œ ë¡œê·¸ì¸ ì´ë©”ì¼ ëˆ„ë½ ë¬¸ì œ](#2-ì¹´ì¹´ì˜¤-ì†Œì…œ-ë¡œê·¸ì¸-ì´ë©”ì¼-ëˆ„ë½-ë¬¸ì œ)
- [OAuth2 ì¸ì¦ ìš”ì²­ ì •ë³´ ì†ì‹¤ ë¬¸ì œ](#3-oauth2-ì¸ì¦-ìš”ì²­-ì •ë³´-ì†ì‹¤-ë¬¸ì œ)

---

ì´ ë¬¸ì„œëŠ” "ë²„í‹°" í”„ë¡œì íŠ¸ë¥¼ ê°œë°œí•˜ë©´ì„œ ë§ˆì£¼ì³¤ë˜ ë¹„êµì  ì‚¬ì†Œí•˜ì§€ë§Œ, ì‹¤ì œ êµ¬í˜„ ê³¼ì •ì—ì„œëŠ” ê½¤ë‚˜ ì‹œê°„ì„ ì¡ì•„ë¨¹ê±°ë‚˜ ì‹œí–‰ì°©ì˜¤ë¥¼ ìœ ë°œí–ˆë˜ ë¬¸ì œë“¤ì„ ê¸°ë¡í•´ë‘ëŠ” ê³µê°„ì…ë‹ˆë‹¤.

ë‹¨ìˆœí•œ ì—ëŸ¬ë¼ê¸°ë³´ë‹¤ëŠ” "í•œ ë²ˆì¯¤ì€ í—·ê°ˆë¦´ ìˆ˜ ìˆëŠ” í¬ì¸íŠ¸ë“¤"ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì •ë¦¬í•˜ì—¬, ë‚˜ì¤‘ì— ìœ ì§€ë³´ìˆ˜í•˜ê±°ë‚˜ ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ ì¬ì‚¬ìš©í•  ë•Œ ì°¸ê³ í•  ìˆ˜ ìˆë„ë¡ ì‘ì„±í•©ë‹ˆë‹¤.

---

## 1. JJWT ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „ì— ë”°ë¥¸ ë³€ê²½ ì‚¬í•­

JJWT ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ì—…ë°ì´íŠ¸ë¡œ ì¸í•´ í† í° ìƒì„± ë° íŒŒì‹± ë°©ì‹ì´ í¬ê²Œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ì‘ì„±ëœ ì½”ë“œëŠ” ë” ì´ìƒ ì»´íŒŒì¼ë˜ì§€ ì•Šê±°ë‚˜ ì‹¤í–‰ ì‹œ ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ğŸ”§ ê¸°ì¡´ ì½”ë“œ (êµ¬ë²„ì „ JJWT)

```java
String secretKey = Base64.getEncoder().encodeToString(secretKey.getBytes());
Claims claims = Jwts.claims().setSubject(user.getNickname());
String accessToken = Jwts.builder()
                .setHeaderParam(Header.TYPE, Header.JWT_TYPE)
                .setClaims(claims)
                .setIssuedAt(now)
                .setExpiration(new Date(now.getTime() + ACCESS_TOKEN_VALID_MILLISECOND))
                .signWith(SignatureAlgorithm.HS256, secretKey)
                .compact();
Claims parsedClaims = Jwts.parser().setSigningKey(secretKey).parseClaimsJws(accessToken).getBody();
```

### âœ… ë³€ê²½ ì½”ë“œ (ìµœì‹  JJWT)

```java
SecretKey secretKey = Keys.hmacShaKeyFor(secretKeyStr.getBytes());
Claims claims = Jwts.claims().subject(user.getNickname()).build();
String accessToken = Jwts.builder()
                .claims(claims)
                .header()
                .type("JWT")
                .and()
                .issuedAt(now)
                .expiration(new Date(now.getTime() + ACCESS_TOKEN_VALID_MILLISECOND))
                .signWith(secretKey, Jwts.SIG.HS256)
                .compact();
Claims parsedClaims = Jwts.parser()
                .verifyWith(secretKey)
                .build()
                .parseSignedClaims(accessToken)
                .getPayload();
```

ì°¸ê³  :

- [Jwt.parserBuilder() Deprecated](https://myeongju00.tistory.com/112)
- [stack overflow](https://stackoverflow.com/questions/78805779/issue-with-parserbuilder-method-in-jjwt-library-for-jwt-token-validation)

---

## 2. ì¹´ì¹´ì˜¤ ì†Œì…œ ë¡œê·¸ì¸ ì´ë©”ì¼ ëˆ„ë½ ë¬¸ì œ

### ğŸ§© ë¬¸ì œ ìƒí™©

ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©ì ì´ë©”ì¼ì´ ì œê³µë˜ì§€ ì•Šì•„ `InternalAuthenticationServiceException` ì´ ë°œìƒí•˜ëŠ” ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤.

### âœ… í•´ê²° ë°©ë²•

ì¹´ì¹´ì˜¤ ê³„ì •ì— ì´ë©”ì¼ ì •ë³´ê°€ ì—†ì„ ê²½ìš° ìë™ìœ¼ë¡œ ìƒì„±ëœ ì´ë©”ì¼ì„ ë¶€ì—¬í•˜ë„ë¡ ë¡œì§ì„ ë³´ì™„í–ˆìŠµë‹ˆë‹¤.

```java
// KakaoOAuth2UserInfo í´ë˜ìŠ¤
@Override
public String getEmail() {
    if (attributes.containsKey("kakao_account")) {
        Map<String, Object> kakaoAccount = (Map<String, Object>) attributes.get("kakao_account");
        if (kakaoAccount != null && kakaoAccount.containsKey("email")) {
            return (String) kakaoAccount.get("email");
        }
    }
    return null; // ìƒìœ„ ë©”ì†Œë“œì—ì„œ ì²˜ë¦¬
}

// OAuth2UserService í´ë˜ìŠ¤
private OAuth2User processOAuth2User(...) {
    String email = oAuth2UserInfo.getEmail();
    if (email == null || email.isEmpty()) {
        email = registrationId + "_" + oAuth2UserInfo.getId() + "@example.com";
        log.debug("ì´ë©”ì¼ ì •ë³´ê°€ ì—†ì–´ ìƒì„±ëœ ì´ë©”ì¼: {}", email);
    }

    // ë‚˜ë¨¸ì§€ ì‚¬ìš©ì ìƒì„±/ì—…ë°ì´íŠ¸ ë¡œì§
    ...
}
```

---

## 3. OAuth2 ì¸ì¦ ìš”ì²­ ì •ë³´ ì†ì‹¤ ë¬¸ì œ

### ğŸ§© ë¬¸ì œ ìƒí™©

ë¡œê·¸ì¸ ì‹œ ë‹¤ìŒê³¼ ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:

```
oauth2LoginException: authorization_request_not_found
```

ì´ìœ ëŠ” Security ì„¤ì •ì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì„¸ì…˜ ìƒì„±ì„ ì™„ì „íˆ ì°¨ë‹¨í–ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤:

```java
http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);
```

OAuth2 ë¡œê·¸ì¸ ê³¼ì •ì€ ë‚´ë¶€ì ìœ¼ë¡œ ì„¸ì…˜ì— ì¸ì¦ ìš”ì²­ ì •ë³´ë¥¼ ì €ì¥í•˜ì—¬ ì¸ì¦ì„ ì´ì–´ê°€ëŠ”ë°, í•´ë‹¹ ì„¤ì •ìœ¼ë¡œ ì¸í•´ ì •ë³´ê°€ ì†ì‹¤ë˜ì—ˆìŠµë‹ˆë‹¤.

### âœ… í•´ê²° ë°©ë²•

ê°œë°œ ì´ˆê¸°ì—ëŠ” ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •ì„ ë³€ê²½í–ˆìŠµë‹ˆë‹¤:

```java
http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED);
```

ì´ë¥¼ í†µí•´ OAuth2 ì¸ì¦ í”Œë¡œìš° ì¤‘ ì„¸ì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤.

### ğŸ’¡ ì¶”ê°€ êµ¬í˜„: ë¦¬í”„ë ˆì‹œ í† í°

ë³´ì•ˆì„±ê³¼ ì‚¬ìš©ì ê²½í—˜ì„ ìœ„í•´ ë¦¬í”„ë ˆì‹œ í† í°ë„ í•¨ê»˜ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

- `RefreshToken` ì—”í‹°í‹° ë° ë¦¬í¬ì§€í† ë¦¬ ìƒì„±
- í† í° ê°±ì‹  ì„œë¹„ìŠ¤ ë° API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„
- ì•¡ì„¸ìŠ¤ í† í°ê³¼ ë¦¬í”„ë ˆì‹œ í† í°ì„ ë¶„ë¦¬ ê´€ë¦¬í•˜ì—¬ ë³´ì•ˆì„± ê°•í™”

---
