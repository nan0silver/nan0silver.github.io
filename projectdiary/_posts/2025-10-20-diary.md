---
layout: post
collection: project_diary
title: ì¹œêµ¬í•˜ì í”„ë¡œì íŠ¸ ì¼ê¸° - Agora Cloud Recording êµ¬í˜„ ì¤‘ Hibernate ì—ëŸ¬ í•´ê²°
description: >
  ìŒì„± í†µí™” ë…¹ìŒ ê¸°ëŠ¥ êµ¬í˜„ ì¤‘ ë¹„ë™ê¸° ì²˜ë¦¬ì—ì„œ ë°œìƒí•œ LazyInitializationExceptionê³¼ OptimisticLockingFailureExceptionì„ í•´ê²°í•œ ê³¼ì •ì„ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.
sitemap: false
---

# [ì¹œêµ¬í•˜ì] Agora Cloud Recording êµ¬í˜„ ì‹œ Hibernate ì—ëŸ¬ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

- [1. ë¬¸ì œ ë°œê²¬](#1-ë¬¸ì œ-ë°œê²¬)
- [2. LazyInitializationException ì´í•´í•˜ê¸°](#2-lazyinitializationexception-ì´í•´í•˜ê¸°)
- [3. OptimisticLockingFailureException ì´í•´í•˜ê¸°](#3-optimisticlockingfailureexception-ì´í•´í•˜ê¸°)
- [4. ë¬¸ì œ ì›ì¸ ë¶„ì„](#4-ë¬¸ì œ-ì›ì¸-ë¶„ì„)
- [5. í•´ê²° ë°©ë²•](#5-í•´ê²°-ë°©ë²•)
- [6. ìµœì¢… í•´ê²° ì½”ë“œ](#6-ìµœì¢…-í•´ê²°-ì½”ë“œ)
- [7. í•µì‹¬ ê°œë… ì •ë¦¬](#7-í•µì‹¬-ê°œë…-ì •ë¦¬)

## ìŒì„± í†µí™” ë…¹ìŒ, ê¸°ëŠ¥ì€ ë™ì‘í•˜ëŠ”ë° ì—ëŸ¬ê°€?

> Agora Cloud Recordingì„ ì´ìš©í•œ ìŒì„± í†µí™” ë…¹ìŒ ê¸°ëŠ¥ì„ êµ¬í˜„í–ˆë‹¤. ë…¹ìŒ ì‹œì‘ê³¼ ì¤‘ì§€ëŠ” ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì˜€ì§€ë§Œ, í†µí™” ì¢…ë£Œ ì§í›„ ì½˜ì†”ì— ì˜ˆì™¸ ìŠ¤íƒì´ ì—°ì†ìœ¼ë¡œ ì¶œë ¥ë˜ì—ˆë‹¤. LazyInitializationExceptionê³¼ OptimisticLockingFailureException... ë‘˜ ë‹¤ ë­”ê°€ ìµìˆ™í•œë° ë™ì‹œì— ë°œìƒí•˜ë‹¤ë‹ˆ..ğŸ¥²

## 1. ë¬¸ì œ ë°œê²¬

### ìƒí™©

Agora Cloud Recordingì„ ì‚¬ìš©í•˜ì—¬ ìŒì„± í†µí™” ë…¹ìŒ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ë˜ ì¤‘, í†µí™”ëŠ” ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ê³  ë…¹ìŒë„ ì‹œì‘ë˜ì§€ë§Œ, **í†µí™” ì¢…ë£Œ ì‹œì ì— ì˜ˆì™¸ê°€ ì—°ë‹¬ì•„ ë°œìƒ**í–ˆë‹¤.

```java
// í†µí™” ì¢…ë£Œ ì‹œ ìë™ìœ¼ë¡œ ë…¹ìŒì„ ì¤‘ì§€í•˜ëŠ” ë¡œì§
@Async("recordingTaskExecutor")
@Transactional
public CompletableFuture<Void> autoStopRecordingOnCallEnd(Long callId) {
    return CompletableFuture.runAsync(() -> {
        stopRecording(callId);  // â† ì—¬ê¸°ì„œ ì—ëŸ¬ ë°œìƒ!
    });
}
```

### ì—ëŸ¬ ë¡œê·¸

```
Cloud Recording ì¤‘ì§€ ì‹¤íŒ¨ - callId: 1
org.hibernate.LazyInitializationException: Could not initialize proxy [com.ldsilver.chingoohaja.domain.call.Call#1] - no session
	at org.hibernate.proxy.AbstractLazyInitializer.initialize(AbstractLazyInitializer.java:174)
	at com.ldsilver.chingoohaja.domain.call.Call$HibernateProxy.getAgoraChannelName(Unknown Source)
	at com.ldsilver.chingoohaja.dto.call.response.RecordingResponse.from(RecordingResponse.java:76)
	at com.ldsilver.chingoohaja.service.AgoraRecordingService.stopRecording(AgoraRecordingService.java:138)
```

ì´ì–´ì„œ ë‘ ë²ˆì§¸ ì—ëŸ¬:

```
Recording ì‹¤íŒ¨ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨ - callId: 1
org.springframework.orm.ObjectOptimisticLockingFailureException: Row was updated or deleted by another transaction (or unsaved-value mapping was incorrect): [com.ldsilver.chingoohaja.domain.call.CallRecording#1]

Caused by: org.hibernate.StaleObjectStateException: Row was updated or deleted by another transaction
```

### ì²« ë²ˆì§¸ ì˜ë¬¸

"ë¶„ëª…íˆ `@Transactional` ì–´ë…¸í…Œì´ì…˜ë„ ë¶™ì˜€ê³ , ì—”í‹°í‹°ë„ ì œëŒ€ë¡œ ì¡°íšŒí–ˆëŠ”ë° ì™œ ì„¸ì…˜ì´ ì—†ë‹¤ëŠ” ê±°ì§€? ê·¸ë¦¬ê³  ì™œ ë‚™ê´€ì  ë½ ì¶©ëŒì´ ë°œìƒí•˜ëŠ” ê±°ì•¼?"

---

## 2. LazyInitializationException ì´í•´í•˜ê¸°

### ì—ëŸ¬ì˜ ì˜ë¯¸

`LazyInitializationException`ì€ Hibernateì—ì„œ **ì§€ì—° ë¡œë”©(Lazy Loading)ìœ¼ë¡œ ì„¤ì •ëœ ì—°ê´€ ì—”í‹°í‹°ì— ì ‘ê·¼í•˜ë ¤ í•  ë•Œ, ì´ë¯¸ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸(Persistence Context)ê°€ ë‹«í˜€ìˆì–´ì„œ ë°œìƒ**í•˜ëŠ” ì—ëŸ¬ë‹¤.

### ì¼ë°˜ì ì¸ ë°œìƒ ìƒí™©

**1. íŠ¸ëœì­ì…˜ ë°–ì—ì„œ Lazy í”„ë¡ì‹œ ì ‘ê·¼**

```java
@Transactional
public User findUser(Long id) {
    return userRepository.findById(id);  // User.ordersëŠ” LAZY
}

// íŠ¸ëœì­ì…˜ ë°– - ì„œë¹„ìŠ¤ ë©”ì„œë“œ ë°–ì´ë‚˜ ì»¨íŠ¸ë¡¤ëŸ¬
user.getOrders().size();  // âŒ LazyInitializationException!
```

**2. íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œëœ í›„ ë¹„ë™ê¸° ì‘ì—…ì—ì„œ ì ‘ê·¼**

```java
@Transactional
public void processOrder(Long orderId) {
    Order order = findOrder(orderId);
    CompletableFuture.runAsync(() -> {
        // ì´ ì‹œì ì—ëŠ” íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë˜ì–´ ì„¸ì…˜ì´ ì—†ìŒ
        order.getUser().getName();  // âŒ LazyInitializationException!
    });
}
```

---

## 3. OptimisticLockingFailureException ì´í•´í•˜ê¸°

### ì—ëŸ¬ì˜ ì˜ë¯¸

`OptimisticLockingFailureException`ì€ **ë‚™ê´€ì  ë½(Optimistic Lock) ê²€ì¦ ì‹¤íŒ¨** ì‹œ ë°œìƒí•˜ëŠ” ì—ëŸ¬ë‹¤. JPAì˜ `@Version`ì„ ì‚¬ìš©í•œ ì—”í‹°í‹°ì—ì„œ **ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ì´ë¯¸ í•´ë‹¹ ë ˆì½”ë“œë¥¼ ìˆ˜ì •í•˜ì—¬ ë²„ì „ì´ ì¦ê°€í–ˆì„ ë•Œ** ë°œìƒí•œë‹¤.

### ì¼ë°˜ì ì¸ ë°œìƒ ìƒí™©

**1. ë™ì‹œì— ê°™ì€ ì—”í‹°í‹°ë¥¼ ìˆ˜ì •**

```java
// íŠ¸ëœì­ì…˜ 1
User user = userRepository.findById(1L);  // version = 0
user.setName("Alice");
userRepository.save(user);  // version = 1ë¡œ ì¦ê°€

// íŠ¸ëœì­ì…˜ 2 (ë™ì‹œ ì‹¤í–‰)
User user = userRepository.findById(1L);  // version = 0 (ì¡°íšŒ ì‹œì )
user.setEmail("new@email.com");
userRepository.save(user);  // âŒ versionì´ ì´ë¯¸ 1ì´ë¼ ì‹¤íŒ¨!
```

**2. ë¶„ë¦¬ëœ(Detached) ì—”í‹°í‹°ë¥¼ merge**

```java
User user = userRepository.findById(1L);  // version = 0
// ì—”í‹°í‹°ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬ë¨
// ... ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì—ì„œ í•´ë‹¹ ì—”í‹°í‹°ë¥¼ ìˆ˜ì •í•˜ì—¬ ë²„ì „ì´ ì¦ê°€
user.setName("Bob");
userRepository.save(user);  // âŒ version ë¶ˆì¼ì¹˜!
```

---

## 4. ë¬¸ì œ ì›ì¸ ë¶„ì„

### âŒ ì—ëŸ¬ 1: LazyInitializationException

ë…¹ìŒ ì¤‘ì§€ ë¡œì§ì—ì„œ `RecordingResponse.from()` ë©”ì„œë“œê°€ `CallRecording` ì—”í‹°í‹°ì˜ ì—°ê´€ëœ `Call` ì—”í‹°í‹°ì— ì ‘ê·¼í•˜ë ¤ í–ˆìœ¼ë‚˜, **ë¹„ë™ê¸° ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ì–´ Hibernate ì„¸ì…˜ì´ ì´ë¯¸ ë‹«í˜€ìˆëŠ” ìƒíƒœ**ì˜€ìŠµë‹ˆë‹¤.

```java
// CallRecording.java
@Entity
public class CallRecording {
    @ManyToOne(fetch = FetchType.LAZY)  // â† LAZY ë¡œë”©!
    @JoinColumn(name = "call_id")
    private Call call;
}

// RecordingResponse.java
public static RecordingResponse from(CallRecording recording) {
    Call call = recording.getCall();  // â† í”„ë¡ì‹œ ê°ì²´
    return new RecordingResponse(
        // ...
        call.getAgoraChannelName(),  // âŒ ì—¬ê¸°ì„œ ì‹¤ì œ ë°ì´í„° ì ‘ê·¼ ì‹œë„!
        // ...
    );
}
```

**ë¬¸ì œ íë¦„:**

1. `@Async` ë©”ì„œë“œë¡œ ë¹„ë™ê¸° ì‹¤í–‰
2. ë¹„ë™ê¸° ìŠ¤ë ˆë“œì—ëŠ” ë³„ë„ì˜ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸
3. `CallRecording` ì¡°íšŒ (Callì€ í”„ë¡ì‹œ ìƒíƒœ)
4. íŠ¸ëœì­ì…˜ ì»¤ë°‹ â†’ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì¢…ë£Œ
5. `call.getAgoraChannelName()` í˜¸ì¶œ ì‹œ í”„ë¡ì‹œ ì´ˆê¸°í™” ì‹œë„
6. ì„¸ì…˜ì´ ì—†ì–´ì„œ **LazyInitializationException** ë°œìƒ!

---

### âŒ ì—ëŸ¬ 2: OptimisticLockingFailureException

ë…¹ìŒ ì¤‘ì§€ ì‹œ **ì—ëŸ¬ ì²˜ë¦¬ ë¡œì§ì—ì„œ `recording.fail()`ì„ í˜¸ì¶œí•˜ì—¬ ìƒíƒœë¥¼ ë³€ê²½**í•˜ë ¤ í–ˆìœ¼ë‚˜, **ì´ë¯¸ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì—ì„œ í•´ë‹¹ ë ˆì½”ë“œë¥¼ ìˆ˜ì •í•˜ì—¬ ë²„ì „ì´ ì¦ê°€**í•œ ìƒíƒœì˜€ìŠµë‹ˆë‹¤.

```java
@Entity
public class CallRecording {
    @Version
    private Integer version;  // â† ë‚™ê´€ì  ë½
}

try {
    // ë…¹ìŒ ì¤‘ì§€ ì‹œë„
    recording.complete(null, null, "hls");
    callRecordingRepository.save(recording);  // version ì¦ê°€
} catch (Exception e) {
    // ì—ëŸ¬ ë°œìƒ ì‹œ
    recording.fail();
    callRecordingRepository.save(recording);  // âŒ version ë¶ˆì¼ì¹˜!
}
```

**ë¬¸ì œ íë¦„:**

1. ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ `recording.complete()` í˜¸ì¶œ â†’ version ì¦ê°€
2. ë¹„ë™ê¸° ìŠ¤ë ˆë“œì—ì„œë„ ê°™ì€ recording ì—”í‹°í‹° ì ‘ê·¼
3. ì—ëŸ¬ ë°œìƒ â†’ `recording.fail()` í˜¸ì¶œ
4. ì €ì¥ ì‹œë„ â†’ **ì´ë¯¸ versionì´ ë³€ê²½ë˜ì–´ OptimisticLockingFailureException!**

---

## ğŸ” í•™ìŠµ í¬ì¸íŠ¸

1. **ë¹„ë™ê¸° ì²˜ë¦¬ ì‹œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬**

   - `@Async` ë©”ì„œë“œëŠ” ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰
   - ê° ìŠ¤ë ˆë“œëŠ” ë…ë¦½ì ì¸ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ê°€ì§
   - JOIN FETCH ë˜ëŠ” EAGER ë¡œë”©ìœ¼ë¡œ í•„ìš”í•œ ë°ì´í„° ë¯¸ë¦¬ ë¡œë“œ

2. **ë™ì‹œì„± ì œì–´ ì „ëµ**

   - ë‚™ê´€ì  ë½: ì¶©ëŒì´ ì ì„ ë•Œ (ì½ê¸° ë§ìŒ)
   - ë¹„ê´€ì  ë½: ì¶©ëŒì´ ë§ì„ ë•Œ (ì“°ê¸° ë§ìŒ)
   - ì˜ˆì™¸ ì²˜ë¦¬ë¡œ ì¬ì‹œë„ ë˜ëŠ” ë¬´ì‹œ ì „ëµ êµ¬í˜„

3. **íŠ¸ëœì­ì…˜ ë²”ìœ„ ì„¤ê³„**
   - `saveAndFlush()`ë¡œ ì¦‰ì‹œ ë°˜ì˜
   - ì—ëŸ¬ ì²˜ë¦¬ ì‹œ ìµœì‹  ë°ì´í„° ì¬ì¡°íšŒ
   - ë‚™ê´€ì  ë½ ì˜ˆì™¸ëŠ” ìƒí™©ì— ë”°ë¼ ë¬´ì‹œ ê°€ëŠ¥

---

## ì°¸ê³  ìë£Œ

- [Hibernate LazyInitializationException ê³µì‹ ë¬¸ì„œ](https://docs.jboss.org/hibernate/orm/6.0/userguide/html_single/Hibernate_User_Guide.html#fetching-LazyInitializationException)
- [JPA Optimistic Locking](https://www.baeldung.com/jpa-optimistic-locking)
- [Spring @Async ë™ì‘ ì›ë¦¬](https://docs.spring.io/spring-framework/reference/integration/scheduling.html)
