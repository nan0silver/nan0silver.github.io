---
layout: post
collection: project_diary
title: ì¹œêµ¬í•˜ì í”„ë¡œì íŠ¸ ì¼ê¸° - í¬ë¡œìŠ¤ ë„ë©”ì¸ í™˜ê²½ì—ì„œ Refresh Token ì¿ í‚¤ ì†Œì‹¤ ë¬¸ì œ í•´ê²°
description: >
  ë°±ì—”ë“œ, í”„ë¡ íŠ¸ ë„ë©”ì¸ì´ ë‹¤ë¥¸ í¬ë¡œìŠ¤ ë„ë©”ì¸ì˜ Production í™˜ê²½ì—ì„œ Refresh Tokenì´ ì‚¬ë¼ì§€ëŠ” ë¬¸ì œì— ëŒ€í•´ ì •ë¦¬í•´ë³´ì•˜ìŠµë‹ˆë‹¤! (í•´ê²°ì€ ë‹¤ìŒí¸)
sitemap: false
---

# [ì¹œêµ¬í•˜ì] í¬ë¡œìŠ¤ ë„ë©”ì¸ í™˜ê²½ì—ì„œ Refresh Token ì¿ í‚¤ ì†Œì‹¤ ë¬¸ì œ

- [ë¬¸ì œ ìƒí™©](#ë¬¸ì œ-ìƒí™©)
- [ì›ì¸ ë¶„ì„](#ì›ì¸-ë¶„ì„)
- [í•´ê²°ë°©ë²•](#í•´ê²°-ë°©ë²•)
- [ì°¸ê³ ì‚¬í•­](#ì°¸ê³ -ì‚¬í•­)

## í¬ë¡œìŠ¤ ë„ë©”ì¸ í™˜ê²½ì—ì„œ Refresh Token ì¿ í‚¤ ì†Œì‹¤ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

- ê°œë°œ í™˜ê²½ì—ì„œëŠ” tokenê´€ë ¨ ë¬¸ì œê°€ ì „í˜€ ì—†ì—ˆë‹¤. ê·¸ëŸ°ë° ë°°í¬í•œ í›„ ë¡œê·¸ì¸ì´ ìƒˆë¡œìš´ íƒ­ì—ì„œ ìœ ì§€ë˜ì§€ ì•ŠëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ê³  í•˜ë‹¤ê°€ Refresh Tokenì´ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì‚¬ë¼ì§€ëŠ”ê±¸ ë°œê²¬í•˜ì˜€ë‹¤.
  > ì–´ë””ê°”ì–´.. ë‚´ refresh token ğŸ¥²
- ë¡œê·¸ì¸ì´ ìœ ì§€ë˜ì§€ ì•ŠëŠ” ë¬¸ì œëŠ” ì™œì¸ì§€ ì•Œì•˜ê¸° ë•Œë¬¸ì— ê¸ˆë°© í•´ê²°í•˜ì˜€ì§€ë§Œ, refresh tokenì´ ì‚¬ë¼ì§€ëŠ” ë¬¸ì œê°€ ë” ë‚˜ë¥¼ í˜ë“¤ê²Œ ë§Œë“¤ì—ˆë‹¤..
- ë”°ë¼ì„œ ì™œ ê·¸ëŸ° ë¬¸ì œê°€ ë°œìƒí•˜ëŠ”ì§€ ì¢€ ë” ì•Œì•„ë³´ê³ ì í–ˆë‹¤.

## ë¬¸ì œ ìƒí™©

- Local í™˜ê²½: Refresh Token ì¿ í‚¤ê°€ ì •ìƒì ìœ¼ë¡œ ìœ ì§€ë¨ âœ…
- Production í™˜ê²½ : ë¡œê·¸ì¸ì€ ì„±ê³µí•˜ì§€ë§Œ, ìƒˆë¡œê³ ì¹¨í•˜ë©´ Refresh Token ì¿ í‚¤ê°€ ì‚¬ë¼ì§ ğŸ‘» (Refresh Tokenì€ HttpOnly Cookieì— ì €ì¥í•¨)
- ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ì—ì„œ í™•ì¸í•œ ì¿ í‚¤ ë§Œë£Œ ì‹œê°„: 30ì¼ âœ…

  > ì²˜ìŒì—” ë§Œë£Œ ì‹œê°„ì´ ì˜ëª» ì„¤ì •ë˜ì–´ìˆëŠ”ì¤„ ì•Œì•˜ë‹¤.

- í™˜ê²½ ì •ë³´

  ```
  Local í™˜ê²½:
  - Frontend: http://localhost:3000
  - Backend:  http://localhost:8080
  - ë™ì¼ í˜¸ìŠ¤íŠ¸(localhost), ë‹¤ë¥¸ í¬íŠ¸ â†’ Same-Site

  Production í™˜ê²½:
  - Frontend: https://chingoo-frontend.vercel.app
  - Backend:  https://your-backend-domain.com
  - ë‹¤ë¥¸ ë„ë©”ì¸ â†’ Cross-Site
  ```

## ì›ì¸ ë¶„ì„

### 1. ì˜ëª»ëœ ì¿ í‚¤ ì„¤ì •

application-prod.ymlì˜ ë¬¸ì œ:

```http
app:
  cookie:
    secure: false     # âŒ HTTPS í™˜ê²½ì¸ë° false
    sam-site: Lax     # âŒ í¬ë¡œìŠ¤ ë„ë©”ì¸ì¸ë° Lax
    max-age: 2592000  # âœ… 30ì¼ (ì •ìƒ)
```

### 2. SamSite ì¿ í‚¤ ì •ì±… ì´í•´í•˜ê¸°

#### SamSite ì†ì„±ì´ë€?

- CSRF(Cross-Site Request Forgery) ê³µê²©ì„ ë°©ì–´í•˜ê¸° ìœ„í•´ ë„ì…ëœ ì¿ í‚¤ ì •ì±…ìœ¼ë¡œ, ì–¸ì œ ì¿ í‚¤ë¥¼ ì „ì†¡í• ì§€ë¥¼ ì œì–´

  > CSRFê³µê²© ì´ë€?
  >
  > > ì‚¬ìš©ìê°€ ìì‹ ì˜ ì˜ì§€ì™€ëŠ” ìƒê´€ì—†ì´ ê³µê²©ìê°€ ì˜ë„í•œ í–‰ìœ„(ìˆ˜ì •, ì‚­ì œ, ë“±ë¡ ë“±)ë¥¼ íŠ¹ì • ì›¹ì‚¬ì´íŠ¸ì— ìš”ì²­í•˜ê²Œ í•˜ëŠ” ê³µê²©
  > > ê³µê²©ìê°€ ì‚¬ìš©ìì˜ ì„¸ì…˜ì„ ê°€ë¡œì±„ëŠ” ë°©ì‹ìœ¼ë¡œ ì¼ì–´ë‚œë‹¤.

- SamSite 3ê°€ì§€ ê°’
  1. Strict
     - ë™ì¼ ì‚¬ì´íŠ¸ì—ì„œë§Œ ì¿ í‚¤ ì „ê³µ
     - ëª¨ë“  í¬ë¡œìŠ¤ ì‚¬ì´íŠ¸ ìš”ì²­ì—ì„œ ì°¨ë‹¨
     - ìµœê³  ìˆ˜ì¤€ ë³´ì•ˆì´ í•„ìš”í•œ ê²½ìš°ì— ì‚¬ìš© (ë§¤ìš° ì—„ê²©í•´ì„œ ì˜ ì•ˆì”€)
  2. Lax (ê¸°ë³¸ê°’)
     - TOP-LEVEL ë„¤ë¹„ê²Œì´ì…˜ + GET ìš”ì²­ë§Œ í—ˆìš©
     - POST, PUT, DELETE ë“±ì€ ì°¨ë‹¨
     - ì¼ë°˜ì ì¸ Sam-Site í™˜ê²½ (í”„ë¡ íŠ¸ì—”ë“œì™€ ë²¡ì—”ë“œê°€ ê°™ì€ ë„ë©”ì¸)
  3. None
     - ëª¨ë“  í¬ë¡œìŠ¤ ì‚¬ì´íŠ¸ ìš”ì²­ì—ì„œ ì¿ í‚¤ì „ì†¡
     - ë‹¨, `Secure=true` í•„ìˆ˜ (HTTPS)
     - í¬ë¡œìŠ¤ ë„ë©”ì¸ í™˜ê²½ (í”„ë¡ íŠ¸ì—”íŠ¸ì™€ ë°±ì—”ë“œ ë„ë©”ì¸ ë‹¤ë¦„)

#### ë¸Œë¼ìš°ì„œì˜ SamSite=Lax ë™ì‘ ë¶„ì„

#### ì‹œë‚˜ë¦¬ì˜¤ 1: ë¡œê·¸ì¸ ì‹œ (ìµœì´ˆ ìš”ì²­)

```http
POST https://your-backend.com/api/v1/auth/login
Origin: https://your-frontend.com
Content-Type: application/json

{"email": "user@example.com", "password": "..."}
```

ë°±ì—”ë“œ ì‘ë‹µ:

```
HTTP/1.1 200 OK
Set-Cookie: refreshToken=eyJhbGc...;
            Path=/;
            Max-Age=2592000;
            HttpOnly;
            Secure;
            SameSite=Lax  â† ì—¬ê¸°ê°€ ë¬¸ì œ! âŒ
Access-Control-Allow-Origin: https://chingoo-frontend.vercel.app
Access-Control-Allow-Credentials: true
```

- ì¿ í‚¤ëŠ” ì„¤ì •ë¨ (ë¸Œë¼ìš°ì €ê°€ Set-Cookie í—¤ë”ë¥¼ ë°›ì•„ì„œ ì €ì¥)
- ê°œë°œì ë„êµ¬ì—ì„œ ì¿ í‚¤ í™•ì¸ ê°€ëŠ¥
- Expires/Max-Ageë„ 30ì¼ë¡œ ì •ìƒ

#### ì‹œë‚˜ë¦¬ì˜¤ 2: ìƒˆë¡œê³ ì¹¨ ì‹œ (ë‘ë²ˆì§¸ ìš”ì²­)

- ì‚¬ìš©ìê°€ ìƒˆë¡œê³ ì¹¨ ë˜ëŠ” í˜ì´ì§€ ì´ë™ ì‹œ, í”„ë¡ íŠ¸ì—”ë“œê°€ ìë™ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” API í˜¸ì¶œ:

```http
// í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ (ìë™ ì‹¤í–‰)
useEffect(() => {
  axios.get('https://your-backend.com/api/v1/users/me', {
    withCredentials: true  // ì¿ í‚¤ ì „ì†¡ ìš”ì²­
  });
}, []);
```

ë¸Œë¼ìš°ì €ì˜ ìš”ì²­:

```
GET https://your-backend.com/api/v1/users/me
Origin: https://your-frontend.com
Cookie: (ì—†ìŒ!) <- SamSite=Laxê°€ ì¿ í‚¤ ì „ì†¡ì„ ì°¨ë‹¨!
```

- TOP-LEVEL ë„¤ë¹„ê²Œì´ì…˜ì´ ì•„ë‹ˆê³  JavaScript ìš”ì²­ì´ê¸° ë•Œë¬¸ì— ì¿ í‚¤ ì „ì†¡ì´ ì•ˆëŒ
  > TOP-LEVEL ë„¤ë¹„ê²Œì´ì…˜ì€ ì•„ë˜ì™€ ê°™ë‹¤.
  >
  > > 1.  ì£¼ì†Œì°½ì— URLì„ ì§ì ‘ ì…ë ¥
  > > 2.  `<a href = "...">` ë§í¬ í´ë¦­
  > > 3.  `window.location.href` ë³€ê²½
  > >     > ```
  > >     >    // âŒ ì´ëŸ° JavaScript ìš”ì²­ì€ TOP-LEVEL ë„¤ë¹„ê²Œì´ì…˜ì´ ì•„ë‹˜
  > >     >    axios.get('https://api.example.com/user');
  > >     >
  > >     >    // âœ… ì´ëŸ° ìš”ì²­ë§Œ TOP-LEVEL ë„¤ë¹„ê²Œì´ì…˜ìœ¼ë¡œ ì¸ì •
  > >     >    window.location.href = 'https://api.example.com/user';
  > >     >    <a href="https://api.example.com/user">í´ë¦­</a>
  > >     > ```

#### ì‹œë‚˜ë¦¬ì˜¤ 3: POST ìš”ì²­

- ì‚¬ìš©ìê°€ í¼ì„ ì œì¶œí•˜ëŠ” ë“± POST ìš”ì²­ì„ ë³´ë‚¼ ë•Œ:

```http
POST https://your-backend.com/api/v1/some-action
Origin: https://your-frontend.com
Cookie: (ì—†ìŒ!) <- SamSite=Laxê°€ ì¿ í‚¤ ì „ì†¡ì„ ì°¨ë‹¨
```

ê²°ê³¼:

- Refresh Token ì¿ í‚¤ê°€ ì „ì†¡ë˜ì§€ ì•ŠìŒ
- ë°±ì—”ë“œì—ì„œ ì¸ì¦ ì‹¤íŒ¨ (401 Unauthorized)
- ì‚¬ìš©ìëŠ” ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì•¼í•¨

## í•´ê²°

- application-prod.yml ìˆ˜ì •

```
app:
  cookie:
    secure: true       # HTTPS í•„ìˆ˜
    same-site: None    # í¬ë¡œìŠ¤ ë„ë©”ì¸ í—ˆìš©
    max-age: 2592000   # 30ì¼
```

- ì´ë¡œ ì¸í•œ CSRF ê³µê²©ì— ëŒ€í•œ ë°©ì–´ëŠ” ë‹¤ìŒ í¸ì—ì„œ ë‹¤ë£¨ê¸°ë¡œ í•œë‹¤.

## ì°¸ê³  ìë£Œ

- [MDN: SamSite cookies](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie/SameSite)
